let getConfig,getAssets,TransactionBuilder,Networks,Operation,Asset,FederationServer,StrKey,Keypair,Server,PUBLIC_HORIZON_URL,TEST_HORIZON_URL,TEST_HORIZON_PASSPHRASE,saveCreds;_3e5‍.x([["issue",()=>issue]]);_3e5‍.w("./config.js",[["getConfig",["getConfig"],function(v){getConfig=v}],["getAssets",["getAssets"],function(v){getAssets=v}]]);_3e5‍.w("stellar-sdk",[["TransactionBuilder",["TransactionBuilder"],function(v){TransactionBuilder=v}],["Networks",["Networks"],function(v){Networks=v}],["Operation",["Operation"],function(v){Operation=v}],["Asset",["Asset"],function(v){Asset=v}],["FederationServer",["FederationServer"],function(v){FederationServer=v}],["StrKey",["StrKey"],function(v){StrKey=v}],["Keypair",["Keypair"],function(v){Keypair=v}],["Server",["Server"],function(v){Server=v}]]);_3e5‍.w("../config.js",[["PUBLIC_HORIZON_URL",["PUBLIC_HORIZON_URL"],function(v){PUBLIC_HORIZON_URL=v}],["TEST_HORIZON_URL",["TEST_HORIZON_URL"],function(v){TEST_HORIZON_URL=v}],["TEST_HORIZON_PASSPHRASE",["TEST_HORIZON_PASSPHRASE"],function(v){TEST_HORIZON_PASSPHRASE=v}]]);_3e5‍.w("./helpers/saveCreds.js",[["default",["saveCreds"],function(v){saveCreds=v}]]);
















 


function initHorizon() {
    if (getConfig("network") === "public") return new Server(PUBLIC_HORIZON_URL);

    if (getConfig("network") === "custom") {
        if (!getConfig("horizon") || !getConfig("passphrase")) {
            console.log("No custom horizon provided, using testnet.")
        } else {
            return new Server(getConfig("horizon"));
        }
    }

    return new Server(TEST_HORIZON_URL);
}
async function initAsset(asset) {
    if( !asset.issuer) {
        console.log(`No issuer for ${asset.code}, using random.`)
        asset.issuer = Keypair.random();
    } else if (!validSeed(asset.issuer)) {
        console.log(`Invalid issuer for ${asset.code}, using random.`)
        asset.issuer = Keypair.random();
    } else {
        asset.issuer = Keypair.fromSecret(asset.issuer); 
    }

    if( !asset.distributor) {
        console.log(`No distributor for ${asset.code}, using random.`)
        asset.distributor = Keypair.random();
    } else if (!validSeed(asset.distributor)) {
        console.log(`Invalid distributor for ${asset.code}, using random.`)
        asset.distributor = Keypair.random();
    } else {
        asset.distributor = Keypair.fromSecret(asset.distributor); 
    }

    await fundAccount(asset.issuer); // TODO: Only for testnet
    await fundAccount(asset.distributor); // TODO: Only for testnet
}
const fundAccount = async (pair) => {
    return Horizon.friendbot(pair.publicKey()).call();
};

const validPk = pk => StrKey.isValidEd25519PublicKey(pk);
const validSeed = seed => StrKey.isValidEd25519SecretSeed(seed);

const Horizon = initHorizon();

const assets = getAssets();

const createDistributor = async (asset, fee) => {

    const account = await Horizon.loadAccount(asset.distributor.publicKey());

    const transaction = new TransactionBuilder(account, { fee, networkPassphrase: TEST_HORIZON_PASSPHRASE }) // TODO: Use other nets, encapsulate TransBuilder
        .addOperation(Operation.changeTrust({
            asset: new Asset(asset.code, asset.issuer.publicKey()),
        }))
        .setTimeout(30)
        .build();

    transaction.sign(asset.distributor);

    return Horizon.submitTransaction(transaction);
};

const distributeAsset = async (asset, fee) => {
    const account = await Horizon.loadAccount(asset.issuer.publicKey());

    const transaction = new TransactionBuilder(account, { fee, networkPassphrase: TEST_HORIZON_PASSPHRASE })
        .addOperation(Operation.payment({
            destination: asset.distributor.publicKey(),
            asset: new Asset(asset.code, asset.issuer.publicKey()),
            amount: '100000000', // TODO: Should be changeable
        }))
        .setTimeout(30)
        .build();

    transaction.sign(asset.issuer.secret());

    return Horizon.submitTransaction(transaction);
};

       async function issue(code) {
    const fee = await Horizon.fetchBaseFee();
    _3e5‍.g.console.log('FEE: ', fee);

    if (!code) {
        assets.forEach( async asset => {
            console.log(`[${asset.code}]:`,"Preparing accounts.")
            await initAsset(asset);

            console.log(`[${asset.code}]:`,"Saving credentials.")
            saveCreds(asset);

            console.log(`[${asset.code}]:`,"Changing distributors trustlines.")
            await createDistributor(asset, fee);
        });
    }
}